<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>XX电台 - Daily Music</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: { 'spin-slow': 'spin 8s linear infinite' }
                }
            }
        }
    </script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        html, body {
            height: 100%;
            overflow: hidden;
            background-color: #111827;
            -webkit-tap-highlight-color: transparent;
        }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // 图标组件库
        const Icons = {
            Play: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className={className}><path fillRule="evenodd" d="M4.5 5.653c0-1.426 1.529-2.33 2.779-1.643l11.54 6.348c1.295.712 1.295 2.573 0 3.285L7.28 19.991c-1.25.687-2.779-.217-2.779-1.643V5.653z" clipRule="evenodd" /></svg>,
            Pause: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className={className}><path fillRule="evenodd" d="M6.75 5.25a.75.75 0 01.75-.75H9a.75.75 0 01.75.75v13.5a.75.75 0 01-.75.75H7.5a.75.75 0 01-.75-.75V5.25zm7.5 0A.75.75 0 0115 4.5h1.5a.75.75 0 01.75.75v13.5a.75.75 0 01-.75.75H15a.75.75 0 01-.75-.75V5.25z" clipRule="evenodd" /></svg>,
            Heart: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z" /></svg>,
            List: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" /></svg>,
            X: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>,
            Music: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg>,
            Quote: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" className={className}><path d="M14.017 21L14.017 18C14.017 16.8954 14.9124 16 16.017 16H19.017C19.5693 16 20.017 15.5523 20.017 15V9C20.017 8.44772 19.5693 8 19.017 8H15.017C14.4647 8 14.017 8.44772 14.017 9V11C14.017 11.5523 13.5693 12 13.017 12H12.017V5H22.017V15C22.017 18.3137 19.3307 21 16.017 21H14.017ZM5.0166 21L5.0166 18C5.0166 16.8954 5.91203 16 7.0166 16H10.0166C10.5689 16 11.0166 15.5523 11.0166 15V9C11.0166 8.44772 10.5689 8 10.0166 8H6.0166C5.46432 8 5.0166 8.44772 5.0166 9V11C5.0166 11.5523 4.56889 12 4.0166 12H3.0166V5H13.0166V15C13.0166 18.3137 10.3303 21 7.0166 21H5.0166Z"></path></svg>,
            // 新增：上一首/下一首图标
            SkipBack: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" className={className}><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>,
            SkipForward: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" className={className}><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
        };

        const { useState, useEffect, useRef } = React;

        const DEFAULT_DATA = [
            {
                id: "demo-001",
                date: "2025.12.08",
                title: "One Last Kiss",
                artist: "宇多田光",
                message: "Loading...",
                quote: "Loading...",
                audioUrl: "",
                coverUrl: "",
                theme: { primary: "#e60012", secondary: "#ffffff" }
            }
        ];

        const MusicCard = () => {
            const [playlist, setPlaylist] = useState(DEFAULT_DATA);
            const [currentIndex, setCurrentIndex] = useState(0);
            const [isPlaying, setIsPlaying] = useState(false);
            const [currentTime, setCurrentTime] = useState(0);
            const [duration, setDuration] = useState(0);
            const [showHistory, setShowHistory] = useState(false);
            const [imgLoaded, setImgLoaded] = useState(null);
            
            const audioRef = useRef(new Audio());
            const canvasRef = useRef(null);
            const animationRef = useRef(null);

            const currentSong = playlist[currentIndex] || DEFAULT_DATA[0];

            // 1. 加载播放列表
            useEffect(() => {
                fetch('./playlist.json')
                    .then(res => res.json())
                    .then(data => { if (Array.isArray(data) && data.length > 0) setPlaylist(data); })
                    .catch(err => console.log("Default data used"));
            }, []);

            // 2. 切歌逻辑 (核心修改：支持自动播放)
            useEffect(() => {
                // 重置时间
                setCurrentTime(0);
                
                // 加载新音频
                if (currentSong.audioUrl) {
                    audioRef.current.src = currentSong.audioUrl;
                    audioRef.current.load();
                    
                    // 关键逻辑：如果当前状态是“播放中”，切歌后继续播放 (实现自动连播)
                    // 注意：首次加载页面时 isPlaying 为 false，所以不会自动播放
                    if (isPlaying) {
                        const playPromise = audioRef.current.play();
                        if (playPromise !== undefined) {
                            playPromise.catch(error => {
                                console.log("自动播放被阻止 (可能是用户未交互):", error);
                                setIsPlaying(false);
                            });
                        }
                    }
                }

                // 加载封面
                if (currentSong.coverUrl) {
                    const img = new Image();
                    img.src = currentSong.coverUrl;
                    img.onload = () => setImgLoaded(img);
                    img.onerror = () => setImgLoaded(null);
                } else {
                    setImgLoaded(null);
                }
            }, [currentIndex, currentSong]); // 依赖项改为 currentIndex 和 currentSong

            // 3. 播放控制与连播监听
            useEffect(() => {
                const audio = audioRef.current;
                
                const handleTimeUpdate = () => setCurrentTime(audio.currentTime);
                const handleLoadedMetadata = () => setDuration(audio.duration);
                
                // 核心修改：当歌曲结束时，自动跳转下一首
                const handleEnded = () => {
                   handleNext(); 
                };

                audio.addEventListener('timeupdate', handleTimeUpdate);
                audio.addEventListener('loadedmetadata', handleLoadedMetadata);
                audio.addEventListener('ended', handleEnded);

                return () => {
                    audio.removeEventListener('timeupdate', handleTimeUpdate);
                    audio.removeEventListener('loadedmetadata', handleLoadedMetadata);
                    audio.removeEventListener('ended', handleEnded);
                };
            }, [playlist.length]); // 依赖项包含 playlist 长度以确保 Next 逻辑正确

            // 上一首
            const handlePrev = (e) => {
                e?.stopPropagation();
                // 算法：(当前 - 1 + 总数) % 总数，实现循环播放
                setCurrentIndex((prev) => (prev - 1 + playlist.length) % playlist.length);
            };

            // 下一首
            const handleNext = (e) => {
                e?.stopPropagation();
                // 算法：(当前 + 1) % 总数，实现循环播放
                setCurrentIndex((prev) => (prev + 1) % playlist.length);
            };

            const togglePlay = () => {
                if (!currentSong.audioUrl) return;
                
                if (isPlaying) {
                    audioRef.current.pause();
                } else {
                    audioRef.current.play().catch(console.error);
                }
                setIsPlaying(!isPlaying);
            };

            // Canvas 渲染 (保持不变)
            useEffect(() => {
                const canvas = canvasRef.current;
                if(!canvas) return;
                const ctx = canvas.getContext('2d');
                
                const updateSize = () => {
                    const dpr = window.devicePixelRatio || 1;
                    const parent = canvas.parentElement;
                    if (!parent) return {w:0, h:0};
                    const rect = parent.getBoundingClientRect();
                    canvas.width = rect.width * dpr;
                    canvas.height = rect.height * dpr;
                    ctx.scale(dpr, dpr);
                    return { w: rect.width, h: rect.height };
                };

                let { w, h } = updateSize();
                window.addEventListener('resize', () => { ({ w, h } = updateSize()) });

                let rotation = 0;

                const render = () => {
                    if (w === 0 || h === 0) return;
                    const cx = w / 2;
                    const cy = h / 2;
                    const radius = Math.min(w, h) * 0.45;

                    ctx.clearRect(0, 0, w, h);

                    if (isPlaying) {
                        const bars = 30;
                        for (let i = 0; i < bars; i++) {
                            const angle = (i / bars) * Math.PI * 2;
                            const barHeight = 4 + Math.sin(Date.now() / 100 + i) * 6 + Math.random() * 8;
                            const rBase = radius + 2;
                            const x1 = cx + Math.cos(angle) * rBase;
                            const y1 = cy + Math.sin(angle) * rBase;
                            const x2 = cx + Math.cos(angle) * (rBase + barHeight);
                            const y2 = cy + Math.sin(angle) * (rBase + barHeight);
                            ctx.beginPath();
                            ctx.moveTo(x1, y1);
                            ctx.lineTo(x2, y2);
                            ctx.strokeStyle = `rgba(255, 255, 255, ${0.1 + Math.random() * 0.15})`;
                            ctx.lineWidth = 2;
                            ctx.stroke();
                        }
                    }

                    ctx.save();
                    ctx.translate(cx, cy);
                    if (isPlaying) rotation += 0.02;
                    ctx.rotate(rotation);

                    ctx.beginPath();
                    ctx.arc(0, 0, radius, 0, Math.PI * 2);
                    ctx.fillStyle = '#111';
                    ctx.fill();

                    ctx.strokeStyle = '#222';
                    ctx.lineWidth = 1;
                    for (let r = radius * 0.35; r < radius - 2; r += 4) {
                        ctx.beginPath();
                        ctx.arc(0, 0, r, 0, Math.PI * 2);
                        ctx.stroke();
                    }

                    ctx.beginPath();
                    ctx.arc(0, 0, radius * 0.35, 0, Math.PI * 2);
                    ctx.clip();
                    if (imgLoaded) {
                        const scale = Math.max((radius * 0.7) / imgLoaded.width, (radius * 0.7) / imgLoaded.height) * 2.2; 
                        const imgW = imgLoaded.width * scale;
                        const imgH = imgLoaded.height * scale;
                        ctx.drawImage(imgLoaded, -imgW / 2, -imgH / 2, imgW, imgH);
                    } else {
                        ctx.fillStyle = currentSong.theme?.secondary || '#fff';
                        ctx.fill();
                        ctx.beginPath();
                        ctx.arc(0, 0, radius * 0.15, 0, Math.PI * 2);
                        ctx.fillStyle = currentSong.theme?.primary || '#e60012';
                        ctx.fill();
                    }
                    ctx.restore();
                    animationRef.current = requestAnimationFrame(render);
                };

                render();
                return () => cancelAnimationFrame(animationRef.current);
            }, [isPlaying, imgLoaded, currentSong]);

            const formatTime = (s) => `${Math.floor(s / 60)}:${Math.floor(s % 60).toString().padStart(2, '0')}`;
            const progress = duration ? (currentTime / duration) * 100 : 0;

            return (
                <div className="h-[100dvh] w-full bg-gray-900 font-sans flex flex-col relative overflow-hidden">
                    
                    <div className="absolute inset-0 overflow-hidden pointer-events-none">
                        <div className="absolute top-[-10%] left-[-10%] w-[60%] h-[40%] bg-blue-500/10 rounded-full blur-[80px]" />
                        <div className="absolute bottom-[20%] right-[-10%] w-[50%] h-[40%] bg-red-500/10 rounded-full blur-[80px]" />
                    </div>

                    {/* Header */}
                    <div className="h-14 flex justify-between items-center px-6 shrink-0 z-20 border-b border-white/5 bg-gray-900/50 backdrop-blur-sm">
                        <div className="flex items-center space-x-2">
                            <span className={`w-2 h-2 rounded-full ${isPlaying ? 'bg-red-500 animate-pulse' : 'bg-gray-500'}`}></span>
                            <span className="text-xs font-bold tracking-widest text-gray-400 uppercase">XX RADIO</span>
                        </div>
                        <div className="text-xs font-mono text-gray-500">{currentSong.date}</div>
                    </div>

                    {/* 唱片区 */}
                    <div className="shrink-0 h-[35vh] min-h-[250px] relative w-full flex items-center justify-center z-10">
                        <canvas ref={canvasRef} className="w-full h-full" />
                        {!isPlaying && (
                             <button 
                                onClick={togglePlay}
                                className="absolute w-14 h-14 bg-black/40 backdrop-blur-sm rounded-full flex items-center justify-center border border-white/20 hover:scale-105 transition-transform"
                            >
                                <Icons.Play className="w-6 h-6 text-white ml-1" />
                            </button>
                        )}
                    </div>

                    {/* 文案区 */}
                    <div className="flex-1 flex flex-col min-h-0 bg-white/5 rounded-t-3xl backdrop-blur-xl border-t border-white/10 z-20 mx-2 mb-2">
                        <div className="px-6 pt-5 pb-3 flex justify-between items-end shrink-0">
                            <div>
                                <h1 className="text-xl font-bold text-white mb-1 line-clamp-1">{currentSong.title}</h1>
                                <p className="text-red-400 text-sm font-medium">{currentSong.artist}</p>
                            </div>
                            <Icons.Heart className="w-6 h-6 text-gray-500" />
                        </div>
                        <div className="flex-1 overflow-y-auto px-6 pb-4 scrollbar-hide">
                            <div className="relative pl-4 border-l-2 border-gray-700/50 py-1">
                                <Icons.Quote className="w-4 h-4 text-gray-600 absolute -top-2 -left-2 bg-gray-900 rounded-full" />
                                <p className="text-gray-300 text-sm md:text-base leading-7 whitespace-pre-line font-light">
                                    {currentSong.message}
                                </p>
                                <p className="text-xs font-serif italic text-gray-500 text-right mt-6">
                                    — {currentSong.quote}
                                </p>
                            </div>
                            <div className="h-4"></div>
                        </div>
                    </div>

                    {/* 底部控制栏 (布局大改：加入上一首/下一首) */}
                    <div className="bg-gray-900/90 backdrop-blur-md border-t border-white/5 px-6 pt-3 pb-3 pb-safe z-30 shrink-0">
                        <div className="flex items-center space-x-3 text-[10px] text-gray-500 font-mono mb-3">
                            <span className="w-8 text-right">{formatTime(currentTime)}</span>
                            <div className="flex-1 h-1 bg-gray-800 rounded-full overflow-hidden">
                                <div className="h-full bg-red-600 transition-all duration-100" style={{ width: `${progress}%` }}></div>
                            </div>
                            <span className="w-8">{formatTime(duration)}</span>
                        </div>

                        <div className="flex items-center justify-between px-2">
                            {/* 列表按钮 */}
                            <button className="text-gray-400 p-2 hover:text-white" onClick={() => setShowHistory(true)}>
                                <Icons.List className="w-6 h-6" />
                            </button>
                            
                            {/* 中央控制区 */}
                            <div className="flex items-center space-x-6">
                                <button onClick={handlePrev} className="text-gray-300 hover:text-white active:scale-95 transition-transform">
                                    <Icons.SkipBack className="w-8 h-8" />
                                </button>
                                
                                <button 
                                    onClick={togglePlay}
                                    className="w-14 h-14 bg-white text-black rounded-full flex items-center justify-center shadow-lg active:scale-95 transition-transform"
                                >
                                    {isPlaying ? <Icons.Pause className="w-7 h-7" /> : <Icons.Play className="w-7 h-7 ml-1" />}
                                </button>

                                <button onClick={handleNext} className="text-gray-300 hover:text-white active:scale-95 transition-transform">
                                    <Icons.SkipForward className="w-8 h-8" />
                                </button>
                            </div>

                            {/* 占位按钮 (保持对称) */}
                            <button className="text-gray-400 p-2 opacity-50 cursor-not-allowed">
                                <Icons.Music className="w-6 h-6" />
                            </button>
                        </div>
                    </div>

                    {/* 历史列表 (逻辑保持不变) */}
                    <div className={`absolute inset-0 z-50 bg-gray-900/95 backdrop-blur-xl transition-transform duration-300 ${showHistory ? 'translate-y-0' : 'translate-y-full'}`}>
                         <div className="flex flex-col h-full p-6 pt-12 pb-safe">
                            <div className="flex justify-between items-center mb-6">
                                <h2 className="text-xl font-bold text-white">历史推送</h2>
                                <button onClick={() => setShowHistory(false)} className="p-2 bg-white/10 rounded-full">
                                    <Icons.X className="w-5 h-5" />
                                </button>
                            </div>
                            <div className="flex-1 overflow-y-auto space-y-3">
                                {playlist.map((song, index) => (
                                    <div 
                                        key={index}
                                        onClick={() => { setCurrentIndex(index); setShowHistory(false); }}
                                        className={`p-4 rounded-xl border flex items-center space-x-4 ${currentIndex === index ? 'bg-red-500/20 border-red-500' : 'bg-white/5 border-white/5'}`}
                                    >
                                        <div className="text-white font-medium flex-1 truncate">
                                            {song.title} 
                                            <div className="text-gray-500 text-xs mt-1">{song.date}</div>
                                        </div>
                                        {currentIndex === index && <div className="w-2 h-2 bg-red-500 rounded-full animate-pulse"/>}
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MusicCard />);
    </script>
</body>
</html>